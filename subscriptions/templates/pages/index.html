{% extends 'base.html' %}
{% load static %}

{% block content %}
    {% include "components/header.html" %}
    <div class="dashboard-grid">
        <section class="panel stats">
            <div class="panel-header">>> –ú–µ—Ç—Ä–∏–∫–∏:</div>
            <div class="stat-row">
                <span>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã:</span>
                {% if monthly_total_by_currency %}
                    {% for currency, total in monthly_total_by_currency.items %}
                        <div>
                            {{ currency }}: {{ total|floatformat:2 }}
                        </div>
                    {% endfor %}
                {% else %}
                    <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –∏–ª–∏ —Ä–∞—Å—á–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.</p>
                {% endif %}
            </div>
            <div class="stat-row">
                <span>–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫:</span>
                <span class="value">{{ active_subscriptions }}</span>
            </div>
            <div style="margin: 4rem 0; background: var(--bg-panel); padding: 2.5rem; border-radius: 8px; border: 1px solid var(--border); height: 320px;">
                <h3 style="margin-bottom: 1rem; ">–†–∞—Å—Ö–æ–¥—ã –ø–æ –º–µ—Å—è—Ü–∞–º (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥)</h3>
                <canvas id="monthlyExpensesChart"></canvas>
            </div>    
        </section>
    </div>
        <div style="margin: 1.5rem 0; text-align: left;">
            <a href="{% url 'pages:add_subscription' %}" class="btn-retro full-width" style="max-width: 220px; display: inline-block; text-align: center;">
                + –ù–û–í–ê–Ø –ü–û–î–ü–ò–°–ö–ê
            </a>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞</th>
                        <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                        <th>–ü–µ—Ä–∏–æ–¥</th>
                        <th>–°–ª–µ–¥—É—é—â–∞—è –æ–ø–ª–∞—Ç–∞</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                {% for sub in subscriptions %}
                <tr class="{% if sub.days_until_next_payment is not None and sub.days_until_next_payment <= 3 %}urgent-row{% endif %}">
                    <td>
                        {% if sub.is_active %}
                            <span class="status-active">‚óè ACTIVE</span>
                        {% else %}
                            <span class="status-inactive">‚óã INACTIVE</span>
                        {% endif %}
                    </td>
                    <td>
                        <strong>{{ sub.name }}</strong><br>
                        {% if sub.note %}
                            <small class="dimmed">{{ sub.note }}</small>
                        {% endif %}
                    </td>
                    <td>{{ sub.get_price_display }}</td>
                    <td>
                        {% if sub.period == 'monthly' %}
                            –ï–∂–µ–º–µ—Å—è—á–Ω–æ
                        {% elif sub.period == 'quarterly' %}
                            –†–∞–∑ –≤ 3 –º–µ—Å
                        {% elif sub.period == 'semi_annual' %}
                            –†–∞–∑ –≤ 6 –º–µ—Å
                        {% elif sub.period == 'annual' %}
                            –†–∞–∑ –≤ –≥–æ–¥
                        {% elif sub.period == 'one_time' %}
                            –û–¥–Ω–æ–∫—Ä–∞—Ç–Ω—ã–π
                        {% endif %}
                    </td>
                    <td class="{% if sub.days_until_next_payment is not None and sub.days_until_next_payment <= 3 %}urgent-text{% endif %}">
                        {{ sub.next_payment_date }} <br>
                        <small class="dimmed">
                            {% with days=sub.days_until_next_payment %}
                                {% if days is not None %}
                                    {% if days > 0 %}
                                        –û—Å—Ç–∞–ª–æ—Å—å {{ days }} –¥–Ω–µ–π
                                    {% elif days == 0 %}
                                        –°–µ–≥–æ–¥–Ω—è
                                    {% else %}
                                        –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞
                                    {% endif %}
                                {% endif %}
                            {% endwith %}
                        </small>
                    </td>
                    <td>
                        <button class="action-btn-active" data-subscription-id="{{ sub.id }}">‚èØ</button>
                        <a href="{% url 'pages:subscription_edit' sub.id %}" class="action-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É">‚úé</a>
                        <form method="post" action="{% url 'pages:subscription_delete' sub.id %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="action-btn" onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É?');">‚úñ</button>
                        </form>
                        {% if sub.is_active %}
                        <button class="action-btn-paid"
                                data-subscription-id="{{ sub.id }}"
                                title="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, —á—Ç–æ –æ–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞">
                            üí≥
                        </button>
    {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="6">–ù–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫</td></tr>
                {% endfor %}
                </tbody>
            </table>  
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = '{{ csrf_token }}'; 

    document.querySelectorAll('.action-btn-active').forEach(function(button) {
        button.addEventListener('click', function() {
            console.log("click")
            const subId = this.dataset.subscriptionId;

            fetch(`/deactivate_subscription/${subId}/`, {
                method: 'POST',
                headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                location.reload();
                } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
            });
        });
    });
});

document.querySelectorAll('.action-btn-paid').forEach(function(button) {
    button.addEventListener('click', function() {
        const subId = this.dataset.subscriptionId;
        
        if (!confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É? –î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–π –æ–ø–ª–∞—Ç—ã –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞.')) {
            return;
        }

        const csrfToken = '{{ csrf_token }}';

        fetch(`/confirm-payment/${subId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏');
        });
    });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('monthlyExpensesChart').getContext('2d');
    
    const chartData = {
        labels: {{ monthly_chart.labels|safe }},
        datasets: [{
            label: '–†–∞—Å—Ö–æ–¥—ã, {{ monthly_chart.currency }}',
            data: {{ monthly_chart.data|safe }},
            backgroundColor: 'rgba(56, 189, 248, 0.65)',
            borderColor: 'rgba(56, 189, 248, 1)',
            borderWidth: 1,
            borderRadius: 4,
        }]
    };

    new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true, labels: { color: '#94a3b8'} },
                title: { display: false }
            },
            scales: {
                x: {
                    grid: { color: 'rgba(51, 65, 85, 0.3)' },
                    ticks: { color: '#94a3b8' }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(51, 65, 85, 0.3)' },
                    ticks: {
                        color: '#94a3b8',
                        callback: function(value) { return value.toLocaleString() + ' ‚ÇΩ'; }
                    }
                }
            }
        }
    });
});
</script>
{% endblock content %}